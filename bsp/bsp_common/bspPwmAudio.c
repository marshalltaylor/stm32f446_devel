#include "bsp.h"
#include "debugUtilities.h"
#include "tim.h"

#define SINE_TABLE_SIZE 0x63
uint8_t sineTable[SINE_TABLE_SIZE] = {
0x80, 0x86, 0x8C, 0x93, 0x99, 0x9F, 0xA5, 0xAB, 0xB1, 0xB6, 0xBC, 0xC1, 0xC5, 0xCA, 0xCE, 0xD2,
0xD6, 0xD9, 0xDC, 0xDF, 0xE1, 0xE3, 0xE4, 0xE5, 0xE6, 0xE6, 0xE6, 0xE5, 0xE4, 0xE3, 0xE1, 0xDF,
0xDC, 0xD9, 0xD6, 0xD3, 0xCF, 0xCB, 0xC6, 0xC1, 0xBC, 0xB7, 0xB1, 0xAC, 0xA6, 0xA0, 0x9A, 0x93,
0x8D, 0x87, 0x80, 0x7A, 0x73, 0x6D, 0x67, 0x61, 0x5B, 0x55, 0x4F, 0x49, 0x44, 0x3F, 0x3A, 0x35,
0x31, 0x2D, 0x2A, 0x26, 0x23, 0x21, 0x1E, 0x1D, 0x1B, 0x1A, 0x19, 0x19, 0x19, 0x1A, 0x1B, 0x1C,
0x1E, 0x20, 0x22, 0x25, 0x28, 0x2C, 0x30, 0x34, 0x38, 0x3D, 0x42, 0x48, 0x4D, 0x53, 0x59, 0x5F,
0x65, 0x6B, 0x71
};

uint32_t sineIndex = 0;

/* TIM1 init function */
__attribute__((used)) static void write_sample(uint32_t input)
{
  htim1.Init.RepetitionCounter = 10;
  //if (HAL_TIM_Base_Init(&htim1) != HAL_OK)
  //{
  //  _Error_Handler(__FILE__, __LINE__);
  //}

  TIM_OC_InitTypeDef sConfigOC;
  
  sConfigOC.OCMode = TIM_OCMODE_PWM1;
  sConfigOC.Pulse = 500;
  sConfigOC.OCPolarity = TIM_OCPOLARITY_HIGH;
  sConfigOC.OCNPolarity = TIM_OCNPOLARITY_HIGH;
  sConfigOC.OCFastMode = TIM_OCFAST_DISABLE;
  sConfigOC.OCIdleState = TIM_OCIDLESTATE_RESET;
  sConfigOC.OCNIdleState = TIM_OCNIDLESTATE_RESET;
  if (HAL_TIM_PWM_ConfigChannel(&htim1, &sConfigOC, TIM_CHANNEL_1) != HAL_OK)
  {
    _Error_Handler(__FILE__, __LINE__);
  }
}

void bspPwmSampleIsr(void)
{
	htim1.Instance->CCR1 = 256 + sineTable[sineIndex];
	sineIndex = sineIndex + 5;
	if(sineIndex >= SINE_TABLE_SIZE)
	{
		sineIndex = 0;
	}
}
